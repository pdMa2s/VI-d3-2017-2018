<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Ataques terroristas</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900"
          rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i"
          rel="stylesheet">
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="vendor/devicons/css/devicons.min.css" rel="stylesheet">
    <link href="vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet">


    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="css/jquery_theme.css">
    <link href="css/resume.css" rel="stylesheet">


</head>

<body id="page-top">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav" style="width: 150px">
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link js-scroll-trigger" href="#sobre">Sobre</a>
            </li>
            <li class="nav-item">
                <a class="nav-link js-scroll-trigger" href="#mapa">Mapa</a>
            </li>
            <li class="nav-item">
                <a class="nav-link js-scroll-trigger" href="#gráfico">Gráfico</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container-fluid p-0">

    <section class="resume-section p-3 p-lg-5 d-flex d-column" id="sobre">
        <div class="my-auto">
            <h1 class="mb-0">Ataques
                <span class="text-primary">terroristas</span>
            </h1>
            <div class="subheading mb-5">Uma análise sobre mais de 170 mil ataques de
                <span class="text-primary">1970-2016</span>
            </div>
            <p class="mb-5"></p>

            <p class="mb-5">Alguns dados a letra grande como número de ataques total, ano com maior numero de
                ataques, média de ataques por ano, média de mortes por ano, média de mortes por ataque, pais com mais
                ataques, pais com mais mortes - analise pode ser feita no pandas em python
            </p>
            <ul class="list-inline list-social-icons mb-0">
                <li class="list-inline-item">
                    <a href="https://www.kaggle.com/START-UMD/gtd">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-database fa-stack-1x fa-inverse"></i>
                </span>
                    </a>
                </li>
            </ul>
        </div>
    </section>

    <section class="resume-section p-3 p-lg-5 d-flex flex-column" id="mapa">
        <div class="my-auto">
            <h2 class="mb-5">mapa</h2>

            <div class="resume-item d-flex flex-column flex-md-row mb-5">
                <div class="resume-content mr-auto">
                    <h3 class="mb-0">Introdução sobre funcionalidades???</h3>
                    <div class="subheading mb-3">Intelitec Solutions</div>
                    <p>texto</p>
                </div>
            </div>
        </div>
        <div style="width: 100%; overflow: hidden;">
            <div id="vista-mapa" style="position: relative; width: 986px; height: 850px; float: left;"></div>
            <div id="slider" name="slider" style="margin-right: 60px; margin-top: 150px; height: 300px; float: right">
                <input type="text" class="min date" id="min" value="1800" readonly>
                <input type="text" class="max date" id="max" value="2015" readonly>
                <button id="zoom-button-1" class="zoom-button" data-zoom="reset">Reset zoom</button>
            </div>

        </div>


        <div style="width: 100%; overflow: hidden;">
            <div id="vista-mapa2" style="position: relative; width: 986px; height: 850px; float: left;"></div>

        </div>
    </section>

    <section class="resume-section p-3 p-lg-5 d-flex flex-column" id="grafico">
        <div class="my-auto">
            <h2 class="mb-5">gráfico</h2>

            <div class="resume-item d-flex flex-column flex-md-row mb-5">
                <div class="resume-content mr-auto">

                </div>
            </div>

        <div id="chartDiv">
            <svg width="500" height="300"></svg>

        </div>
        </div>
    </section>


<!-- Bootstrap core JavaScript -->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Plugin JavaScript -->
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom scripts for this template -->
<script src="js/resume.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<!-- <script src="https://d3js.org/d3.v4.min.js"></script>-->
<script src="http://d3js.org/topojson.v1.min.js"></script>
<!-- I recommend you host this file on your own, since this will change without warning -->
<script src="http://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>


<script>
    function processCountryNames(name) {
        switch (name) {
            case "United States":
                return "United States of America";
                break;
            case "Slovak Republic":
                return "Slovakia";
                break;
            case "Tanzania":
                return "United Republic of Tanzania";
                break;
            case "Guinea-Bissau":
                return "Guinea Bissau";
                break;
            case "Serbia":
                return "Republic of Serbia";
                break;
            case "Bosnia-Herzegovina":
                return "Bosnia and Herzegovina";
                break;
            case "Kosovo":
                return "Kosovo";
                break;
            case "Bahamas":
                return "The Bahamas";
                break;
            default:
                return name;
        }
    }

    function palette(min, max) {
        var d = (max - min) / 10;
        return d3.scale.threshold()
            .range(['#58fa58', '#a3fe30', '#d5ff00', '#ffff00', '#ffc400', '#ff8900', '#ff4000', '#ff2200', '#d70002', '#8b0000'])
            .domain([min + 100, min + 2 * 750, min + 3 * d, min + 4 * d, min + 5 * d, min + 6 * d, min + 7 * d, min + 8 * d, min + 9 * d, min + 10 * d]);
    }

    function decodeColor(colorCode) {
        return colorCode.replace("$", "#");
    }

    function codeColor(colorCode) {
        return colorCode.replace("#", "$");
    }

  function getAttackArray(yearAtacks){
    var atackArray = [];
    for (var property in yearAtacks) {
        if (yearAtacks.hasOwnProperty(property)) {
          // do stuff
          atackArray.push({'year': property, 'nrAttacks': yearAtacks[property]})
        }
      }
      return atackArray;
  }
</script>
<script>
    var map1;
    var map2;
    var terroristData = {};
    var countryAtacks = {};
    var countries = Datamap.prototype.worldTopo.objects.world.geometries;
    var mapData = {};
    var points = [];
    var filteredPoints;
    var minAtacks = Number.MAX_SAFE_INTEGER;
    var maxAtacks = 0;
    var zoom1;
    var zoom2;
    var scale = 1.0;

    d3.csv("relevant_terrorist.csv", function (data) {
        data.forEach(function (element) {
            if (element.latitude !== "" && element.longitude !== "" && element.nkill !== "" && element.nkill > 0.0) {
                var deaths = parseFloat(element.nkill);
                var raio = 1;

                if (deaths >= 1 && deaths <= 100) {
                    raio = 4;
                }

                if (deaths >= 101 && deaths <= 300) {
                    raio = 8;
                }

                else if (deaths >= 301 && deaths <= 601) {
                    raio = 13;
                }

                else if (deaths >= 602 && deaths <= 902) {
                    raio = 18;
                }

                else if (deaths >= 903 && deaths <= 1200) {
                    raio = 23;
                }

                else if (deaths > 1200) {
                    raio = 27;
                }

                points.push({
                    year: parseInt(element.iyear),
                    latitude: element.latitude,
                    longitude: element.longitude,
                    fillKey: 'pnt',
                    radius: raio,
                    nkills: deaths
                });
            }

            if (terroristData[processCountryNames(element.country_txt)] == null) {
                terroristData[processCountryNames(element.country_txt)] = [element];
                countryAtacks[processCountryNames(element.country_txt)] = {};
                countryAtacks[processCountryNames(element.country_txt)][element.iyear] = 1;
            }

            else {
                terroristData[processCountryNames(element.country_txt)].push(element);
                var nrAtacks = terroristData[processCountryNames(element.country_txt)].length;
                if (nrAtacks > maxAtacks) {
                    maxAtacks = nrAtacks;
                }
                if (nrAtacks < minAtacks) {
                    minAtacks = nrAtacks;
                }
                if(countryAtacks[processCountryNames(element.country_txt)][element.iyear] == null){
                  countryAtacks[processCountryNames(element.country_txt)][element.iyear] = 1;
                }
                else{
                  countryAtacks[processCountryNames(element.country_txt)][element.iyear] =  countryAtacks[processCountryNames(element.country_txt)][element.iyear] + 1;
                  //console.log(countryAtacks[processCountryNames(element.country_txt)][element.iyear]);
                }
            }
        });

        var colorPicker = palette(minAtacks, maxAtacks + 1);
        for (var i = 0, j = countries.length; i < j; i++) {
            if (terroristData[countries[i].properties.name] != null) {
                let cNrAttacks = terroristData[countries[i].properties.name].length;
                mapData[countries[i].id] = {
                    attacks : cNrAttacks,
                    fillKey: codeColor(colorPicker(cNrAttacks))
                }
            }
            else {
                mapData[countries[i].id] = {
                    attacks : "N/a",
                    fillKey: 'noData'
                }
            }
        }
        //######chart###########3
        var selectedCountry = "Afghanistan";

        var margin = {top: 20, right: 20, bottom: 30, left: 80},
        width =  600 + margin.left - margin.right,
        height = 270 + margin.top - margin.bottom;
        var svg = d3.select("svg")
            //.append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");



        var x = d3.scale.linear().range([0, width]);

        var y = d3.scale.linear().range([height, 0]);

        var valueLine = d3.svg.line()
            .x(function(d) { return x(d.year); })
            .y(function(d) { return y(d.nrAttacks);});

        var atacksYear = getAttackArray(countryAtacks[selectedCountry]);

          x.domain(d3.extent(atacksYear, function(d) { return d.year; }));
          y.domain(d3.extent(atacksYear, function(d) { return d.nrAttacks; }));
          var xAxis = d3.svg.axis().orient("bottom").scale(x);
          svg.append("g")
              .attr("class", "xAxis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis)
              //.remove();
        var yAxis = d3.svg.axis().orient("left").scale(y);
          svg.append("g")
              .attr("class", "yAxis")
              .call(yAxis)
              .append("text")
              .attr("text-anchor", "end")
              .text("Nº Attacks");

          svg.append("path")
              .attr("class", "chartLine")
              .attr("fill", "none")
              .attr("stroke", "steelblue")
              .attr("stroke-linejoin", "round")
              .attr("stroke-linecap", "round")
              .attr("stroke-width", 3)
              .attr("d", valueLine(atacksYear));
        var svgUpdate = d3.select("svg").select("g").transition();

        map1 = new Datamap({
            scope: 'world',
            element: document.getElementById('vista-mapa2'),
            projection: 'mercator',
            legend: true,
            labels: true,
            fills: {
                noData: '#6E6E6E',
                $58fa58: '#58fa58',
                $a3fe30: '#a3fe30',
                $d5ff00: '#d5ff00',
                $ffff00: '#ffff00',
                $ffc400: '#ffc400',
                $ff8900: '#ff8900',
                $ff4000: '#ff4000',
                $ff2200: '#ff2200',
                $d70002: '#d70002',
                $8b0000: '#8b0000'
            },
            data: mapData,
            geographyConfig: {
                 popupTemplate:  function(geography, data){
                    return '<div class=hoverinfo><strong>' + geography.properties.name +
                      '<br />' + "Ataques: " + data.attacks + '</strong></div>';
                  }
                },
            done: function(datamap) {

                datamap.svg.selectAll('.datamaps-subunit').on('click', function(geo) {

                selectedCountry = geo.properties.name;
                updateData(getAttackArray(countryAtacks[geo.properties.name]))
              })
            }
        });



              // ** Update data section (Called from the onclick)
              function updateData(updateData) {
                  console.log(updateData);

                  // Select the section we want to apply our changes to
                  svg.selectAll("*").remove();

                  svg.attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom)
                  .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

              var x = d3.scale.linear().range([0, width]);

              var y = d3.scale.linear().range([height, 0]);

              var valueLine = d3.svg.line()
                  .x(function(d) { return x(d.year); })
                  .y(function(d) { return y(d.nrAttacks);});
              //var atacksYear = getAttackArray(countryAtacks['Afghanistan']);
                x.domain(d3.extent(updateData, function(d) { return d.year; }));
                y.domain(d3.extent(updateData, function(d) { return d.nrAttacks; }));
                var xAxis = d3.svg.axis().orient("bottom").scale(x);
                svg.append("g")
                    .attr("class", "xAxis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                    //.remove();
              var yAxis = d3.svg.axis().orient("left").scale(y);
                svg.append("g")
                    .attr("class", "yAxis")
                    .call(yAxis)
                    .append("text")
                    .attr("text-anchor", "end")
                    .text("Nº Attacks");

                svg.append("path")
                    .attr("class", "chartLine")
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr("stroke-width", 3)
                    .attr("d", valueLine(updateData));


              }
             //######chart###########3

        map2 = new Datamap({
            scope: 'world',
            element: document.getElementById('vista-mapa'),
            projection: 'mercator',
            fills: {
                'pnt': 'red',
                noData: '#6E6E6E',
                $58fa58: '#ABDDA4',
                $a3fe30: '#ABDDA4',
                $d5ff00: '#ABDDA4',
                $ffff00: '#ABDDA4',
                $ffc400: '#ABDDA4',
                $ff8900: '#ABDDA4',
                $ff4000: '#ABDDA4',
                $ff2200: '#ABDDA4',
                $d70002: '#ABDDA4',
                $8b0000: '#ABDDA4'
            },
            data: mapData,
            done: function(datamap) {
                zoom2 = d3.behavior.zoom();
                datamap.svg.call(zoom2.on("zoom", redraw));
                function redraw() {
                    datamap.svg.selectAll("g").attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
                }
            }
        });

        filteredPoints = points.filter(function (el) {
            return parseInt(el.year) >= min && parseInt(el.year) <= max;
        });

        map2.bubbles(filteredPoints, {
            fillOpacity: 0.5,
            borderWidth: 1,
            borderColor: '#990000',
            popupOnHover: false,
            highlightOnHover: false
        });
    });

    $min_input = $('#min');
    $max_input = $('#max');

    $slider = $('#slider').slider({
        orientation: 'vertical',
        animate: "fast",
        range: true,
        min: 1970,
        max: 2016,
        values: [2016, 2016],
        slide: function (event, ui) {
            adjust(ui.values[0], ui.values[1]);
        },
        stop: function (event, ui){
            updateMap(ui.values[0], ui.values[1]);
        }
    });

    function adjust(min, max) {
        $min_input.val(min);
        $max_input.val(max);
        $slider.find('.ui-slider-handle:first-of-type').attr('data-content', min);
        $slider.find('.ui-slider-handle:last-of-type').attr('data-content', max);
    }

    function updateMap(min, max) {
        filteredPoints = points.filter(function (el) {
            return parseInt(el.year) >= min && parseInt(el.year) <= max;
        });

        map2.bubbles(filteredPoints, {
            fillOpacity: 0.5,
            borderWidth: 1,
            borderColor: '#990000',
            popupOnHover: false,
            highlightOnHover: false
        });
     }


    var min = $slider.slider('values', 0);
    var max = $slider.slider('values', 1);
    adjust(min, max);

    $("#zoom-button-1").click(function () {
        map2.svg.selectAll("g").attr("transform", "translate(0,0)scale(1,1)");
        zoom2.scale(scale).translate([0,0]);
    });

    $("#zoom-button-2").click(function () {
        map1.svg.selectAll("g").attr("transform", "translate(0,0)scale(1,1)");
        zoom1.scale(scale).translate([0,0]);
    });

</script>

</body>

</html>
